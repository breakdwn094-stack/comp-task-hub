<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CompHub - Compensation Operations Hub</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/prop-types@15/prop-types.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    html, body, #root { margin: 0; padding: 0; height: 100%; font-family: 'Figtree', system-ui, -apple-system, sans-serif; background: #f6f7fb; }

    /* Monday.com style scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #c3c6d4; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #a0a4b8; }

    /* Animations */
    @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes slideOutRight { from { transform: translateX(0); } to { transform: translateX(100%); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .panel-enter { animation: slideInRight 0.25s ease-out; }
    .fade-enter { animation: fadeIn 0.2s ease; }
    .dropdown-enter { animation: slideDown 0.15s ease-out; }
    .toast-anim { animation: toastIn 0.3s ease; }

    /* Monday.com table styles */
    .monday-table { border-collapse: separate; border-spacing: 0; width: 100%; }
    .monday-table th { position: sticky; top: 0; z-index: 5; background: #fff; }

    .group-header { cursor: pointer; user-select: none; }
    .group-header:hover { filter: brightness(0.95); }

    .task-row { border-bottom: 1px solid #e6e9ef; transition: background 0.1s; }
    .task-row:hover { background: #f5f6ff !important; }

    /* Inline edit cell hover indicator */
    .cell-editable { cursor: pointer; position: relative; transition: background 0.1s; min-height: 38px; display: flex; align-items: center; }
    .cell-editable:hover { background: rgba(0,115,234,0.04); }

    /* Status/Priority cells */
    .status-cell, .priority-cell {
      display: flex; align-items: center; justify-content: center;
      padding: 4px 0; font-size: 13px; font-weight: 500;
      cursor: pointer; transition: filter 0.15s; min-height: 38px;
      border-right: 1px solid rgba(0,0,0,0.06);
    }
    .status-cell:hover, .priority-cell:hover { filter: brightness(0.92); }

    /* Dropdown */
    .cell-dropdown {
      position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
      background: #fff; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      z-index: 50; min-width: 160px; padding: 6px;
      animation: slideDown 0.15s ease-out;
    }
    .cell-dropdown-option {
      padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;
      display: flex; align-items: center; gap: 8px; transition: background 0.1s;
    }
    .cell-dropdown-option:hover { background: #f0f1f5; }

    /* Owner avatar */
    .owner-avatar {
      width: 28px; height: 28px; border-radius: 50%; display: flex;
      align-items: center; justify-content: center; font-size: 11px;
      font-weight: 600; color: #fff; flex-shrink: 0;
    }

    /* Sidebar */
    .sidebar-board-item {
      padding: 6px 12px 6px 32px; border-radius: 4px; cursor: pointer;
      font-size: 13px; color: #c3c6d4; transition: all 0.1s;
      display: flex; align-items: center; gap: 8px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .sidebar-board-item:hover { background: rgba(255,255,255,0.08); color: #fff; }
    .sidebar-board-item.active { background: rgba(0,115,234,0.25); color: #fff; }

    .sidebar-domain-header {
      padding: 6px 12px; cursor: pointer; display: flex; align-items: center;
      gap: 6px; font-size: 13px; font-weight: 600; color: #9699a8;
      transition: color 0.1s; user-select: none;
    }
    .sidebar-domain-header:hover { color: #fff; }

    /* View tabs */
    .view-tab {
      padding: 6px 14px; border-radius: 4px; font-size: 13px; font-weight: 500;
      cursor: pointer; transition: all 0.15s; color: #676879; border: 1px solid transparent;
    }
    .view-tab:hover { background: #e6e9ef; }
    .view-tab.active { background: #cce5ff; color: #0073ea; border-color: #0073ea30; }

    /* Detail panel */
    .detail-panel {
      position: fixed; right: 0; top: 0; bottom: 0; width: 480px;
      background: #fff; box-shadow: -4px 0 24px rgba(0,0,0,0.12); z-index: 100;
      animation: slideInRight 0.25s ease-out; display: flex; flex-direction: column;
    }

    /* Kanban card */
    .kanban-card {
      background: #fff; border-radius: 8px; padding: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08); cursor: pointer;
      transition: box-shadow 0.15s, transform 0.15s; border: 1px solid #e6e9ef;
    }
    .kanban-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); transform: translateY(-1px); }

    /* Metric card */
    .metric-card {
      background: #fff; border-radius: 8px; padding: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06); border: 1px solid #e6e9ef;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useCallback, useRef } = React;
    const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Legend } = window.Recharts;

    // ===================== CONSTANTS =====================
    const API = "/api";

    const STATUS_MAP = {
      not_started: { label: "Not Started", color: "#c4c4c4", textColor: "#fff" },
      in_progress: { label: "In Progress", color: "#fdab3d", textColor: "#fff" },
      in_review:   { label: "In Review",   color: "#e2445c", textColor: "#fff" },
      blocked:     { label: "Blocked",     color: "#df2f4a", textColor: "#fff" },
      complete:    { label: "Done",        color: "#00c875", textColor: "#fff" },
    };
    const STATUS_ORDER = ["not_started", "in_progress", "in_review", "blocked", "complete"];

    const PRIORITY_MAP = {
      critical: { label: "Critical", color: "#e2445c", textColor: "#fff" },
      high:     { label: "High",     color: "#fdab3d", textColor: "#fff" },
      medium:   { label: "Medium",   color: "#579bfc", textColor: "#fff" },
      low:      { label: "Low",      color: "#c4c4c4", textColor: "#fff" },
    };

    const OWNER_COLORS = {
      "Director": "#7B68EE", "Manager": "#FF6B6B", "Lead": "#4ECDC4",
      "Sr Analyst": "#45B7D1", "Analyst": "#96CEB4", "Admin": "#FFEAA7",
      "Legal": "#DDA0DD", "Finance": "#98D8C8", "HRBP": "#F8B739",
    };
    const OWNERS = Object.keys(OWNER_COLORS);
    const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    const DOMAIN_META = {
      "base-pay":     { name: "Base Pay & Structures",       color: "#579bfc", icon: "D" },
      "variable-pay": { name: "Variable Pay & Incentives",   color: "#00c875", icon: "T" },
      "exec-comp":    { name: "Executive Compensation",      color: "#a25ddc", icon: "B" },
      "global":       { name: "Global / International",      color: "#66ccff", icon: "G" },
      "compliance":   { name: "Compliance & Governance",     color: "#fdab3d", icon: "S" },
      "operations":   { name: "Operations & Administration", color: "#7f5fff", icon: "O" },
    };

    const BOARDS = [
      { id: "salary-structure", name: "Annual Salary Structure Review", domain: "base-pay" },
      { id: "market-pricing", name: "Market Pricing & Benchmarking", domain: "base-pay" },
      { id: "merit-cycle", name: "Annual Merit Cycle", domain: "base-pay" },
      { id: "pay-equity", name: "Pay Equity Analysis", domain: "base-pay" },
      { id: "job-architecture", name: "Job Architecture & Evaluation", domain: "base-pay" },
      { id: "annual-incentive", name: "Annual Incentive Plan (AIP)", domain: "variable-pay" },
      { id: "sales-comp", name: "Sales Compensation Management", domain: "variable-pay" },
      { id: "lti-equity", name: "Long-Term Incentive / Equity", domain: "variable-pay" },
      { id: "recognition", name: "Recognition & Spot Awards", domain: "variable-pay" },
      { id: "retention", name: "Retention Program Management", domain: "variable-pay" },
      { id: "exec-annual", name: "Annual Executive Comp Cycle", domain: "exec-comp" },
      { id: "proxy-cda", name: "Proxy Statement & CD&A", domain: "exec-comp" },
      { id: "board-committee", name: "Compensation Committee", domain: "exec-comp" },
      { id: "director-comp", name: "Board of Directors Comp", domain: "exec-comp" },
      { id: "exec-benefits", name: "Executive Benefits & Perqs", domain: "exec-comp" },
      { id: "global-structures", name: "Global Pay Structures", domain: "global" },
      { id: "global-mobility", name: "Global Mobility & Expat", domain: "global" },
      { id: "intl-compliance", name: "International Compliance", domain: "global" },
      { id: "reg-compliance", name: "Regulatory Compliance", domain: "compliance" },
      { id: "pay-transparency", name: "Pay Transparency & Reporting", domain: "compliance" },
      { id: "comp-governance", name: "Compensation Governance", domain: "compliance" },
      { id: "survey-mgmt", name: "Survey Management", domain: "operations" },
      { id: "hris-tech", name: "HRIS & Technology", domain: "operations" },
      { id: "budget-planning", name: "Budget & Financial Planning", domain: "operations" },
      { id: "team-stakeholder", name: "Team & Stakeholders", domain: "operations" },
    ];

    // ===================== ICONS (SVG) =====================
    const mkI = (d) => ({size=18, color, className=""} = {}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24"
        fill="none" stroke={color||"currentColor"} strokeWidth={2} strokeLinecap="round"
        strokeLinejoin="round" className={className} style={{display:"inline-block",verticalAlign:"middle",flexShrink:0}}
        dangerouslySetInnerHTML={{__html:d}} />
    );
    const IcoSearch = mkI(`<circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>`);
    const IcoChevDown = mkI(`<path d="m6 9 6 6 6-6"/>`);
    const IcoChevRight = mkI(`<path d="m9 18 6-6-6-6"/>`);
    const IcoPlus = mkI(`<path d="M5 12h14"/><path d="M12 5v14"/>`);
    const IcoX = mkI(`<path d="M18 6 6 18"/><path d="m6 6 12 12"/>`);
    const IcoRefresh = mkI(`<polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>`);
    const IcoTrash = mkI(`<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>`);
    const IcoMsg = mkI(`<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>`);
    const IcoActivity = mkI(`<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>`);
    const IcoDash = mkI(`<rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/>`);
    const IcoTable = mkI(`<path d="M12 3v18"/><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/>`);
    const IcoKanban = mkI(`<rect width="6" height="14" x="2" y="5" rx="1"/><rect width="6" height="8" x="9" y="5" rx="1"/><rect width="6" height="11" x="16" y="5" rx="1"/>`);
    const IcoCal = mkI(`<rect width="18" height="18" x="3" y="4" rx="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/>`);
    const IcoStar = mkI(`<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>`);
    const IcoHome = mkI(`<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>`);
    const IcoClock = mkI(`<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>`);
    const IcoCheck = mkI(`<circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>`);
    const IcoAlert = mkI(`<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/>`);
    const IcoSend = mkI(`<path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/>`);
    const IcoMenu = mkI(`<line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>`);

    // ===================== HELPERS =====================
    const fmtDate = (d) => { if(!d) return ""; const dt = new Date(d); return dt.toLocaleDateString("en-US", {month:"short",day:"numeric"}); };
    const fmtDateFull = (d) => { if(!d) return ""; const dt = new Date(d); return dt.toLocaleDateString("en-US", {month:"short",day:"numeric",year:"numeric"}); };
    const fmtTime = (d) => { if(!d) return ""; const dt = new Date(d); return dt.toLocaleTimeString("en-US", {hour:"numeric",minute:"2-digit"}); };
    const getInitials = (name) => name.split(" ").map(w => w[0]).join("").toUpperCase().slice(0,2);
    const ownerColor = (name) => OWNER_COLORS[name] || "#888";

    // ===================== CLICK OUTSIDE HOOK =====================
    function useClickOutside(ref, handler) {
      useEffect(() => {
        const listener = (e) => { if (ref.current && !ref.current.contains(e.target)) handler(); };
        document.addEventListener("mousedown", listener);
        return () => document.removeEventListener("mousedown", listener);
      }, [ref, handler]);
    }

    // ===================== TOAST =====================
    function Toast({ message, type="success", onClose }) {
      useEffect(() => { const t = setTimeout(onClose, 2500); return () => clearTimeout(t); }, [onClose]);
      const bg = type === "success" ? "#00c875" : "#e2445c";
      return (
        <div className="toast-anim" style={{position:"fixed",top:16,right:16,zIndex:200,background:bg,color:"#fff",padding:"10px 20px",borderRadius:8,fontSize:14,fontWeight:500,boxShadow:"0 4px 12px rgba(0,0,0,0.15)"}}>
          {message}
        </div>
      );
    }

    // ===================== INLINE DROPDOWN =====================
    function InlineDropdown({ options, value, onSelect, renderOption, cellStyle, renderValue }) {
      const [open, setOpen] = useState(false);
      const ref = useRef(null);
      useClickOutside(ref, () => setOpen(false));
      return (
        <div ref={ref} style={{position:"relative",...cellStyle}} onClick={(e) => { e.stopPropagation(); setOpen(!open); }}>
          {renderValue ? renderValue(value) : value}
          {open && (
            <div className="cell-dropdown" onClick={e => e.stopPropagation()}>
              {options.map(opt => (
                <div key={opt.id || opt} className="cell-dropdown-option" onClick={() => { onSelect(opt.id || opt); setOpen(false); }}>
                  {renderOption ? renderOption(opt) : (opt.label || opt)}
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // ===================== STATUS CELL =====================
    function StatusCell({ value, onChange }) {
      const meta = STATUS_MAP[value] || STATUS_MAP.not_started;
      return (
        <InlineDropdown
          options={STATUS_ORDER.map(id => ({ id, ...STATUS_MAP[id] }))}
          value={value}
          onSelect={onChange}
          cellStyle={{ background: meta.color, color: meta.textColor, justifyContent:"center", textAlign:"center", fontSize:13, fontWeight:500, padding:"0 8px", minHeight:38, display:"flex", alignItems:"center", cursor:"pointer", borderRight:"1px solid rgba(0,0,0,0.06)" }}
          renderValue={() => meta.label}
          renderOption={(opt) => (
            <React.Fragment>
              <span style={{width:12,height:12,borderRadius:3,background:opt.color,flexShrink:0}}></span>
              <span>{opt.label}</span>
            </React.Fragment>
          )}
        />
      );
    }

    // ===================== PRIORITY CELL =====================
    function PriorityCell({ value, onChange }) {
      const meta = PRIORITY_MAP[value] || PRIORITY_MAP.medium;
      return (
        <InlineDropdown
          options={["critical","high","medium","low"].map(id => ({ id, ...PRIORITY_MAP[id] }))}
          value={value}
          onSelect={onChange}
          cellStyle={{ background: meta.color, color: meta.textColor, justifyContent:"center", textAlign:"center", fontSize:13, fontWeight:500, padding:"0 8px", minHeight:38, display:"flex", alignItems:"center", cursor:"pointer", borderRight:"1px solid rgba(0,0,0,0.06)" }}
          renderValue={() => meta.label}
          renderOption={(opt) => (
            <React.Fragment>
              <span style={{width:12,height:12,borderRadius:3,background:opt.color,flexShrink:0}}></span>
              <span>{opt.label}</span>
            </React.Fragment>
          )}
        />
      );
    }

    // ===================== OWNER CELL =====================
    function OwnerCell({ value, onChange }) {
      return (
        <InlineDropdown
          options={OWNERS}
          value={value}
          onSelect={onChange}
          cellStyle={{ padding:"0 10px", minHeight:38, display:"flex", alignItems:"center", cursor:"pointer", gap:6, borderRight:"1px solid rgba(0,0,0,0.06)", fontSize:13 }}
          renderValue={(v) => (
            <React.Fragment>
              <span className="owner-avatar" style={{background:ownerColor(v),width:26,height:26,fontSize:10}}>{getInitials(v)}</span>
              <span style={{color:"#323338"}}>{v}</span>
            </React.Fragment>
          )}
          renderOption={(opt) => (
            <React.Fragment>
              <span className="owner-avatar" style={{background:ownerColor(opt),width:24,height:24,fontSize:10}}>{getInitials(opt)}</span>
              <span>{opt}</span>
            </React.Fragment>
          )}
        />
      );
    }

    // ===================== DATE CELL =====================
    function DateCell({ value, onChange }) {
      const [editing, setEditing] = useState(false);
      const ref = useRef(null);
      useClickOutside(ref, () => setEditing(false));

      if (editing) {
        return (
          <div ref={ref} style={{padding:"0 6px",minHeight:38,display:"flex",alignItems:"center",borderRight:"1px solid rgba(0,0,0,0.06)"}} onClick={e => e.stopPropagation()}>
            <input type="date" defaultValue={value?.split("T")[0] || ""} autoFocus
              style={{border:"1px solid #0073ea",borderRadius:4,padding:"2px 6px",fontSize:13,outline:"none",width:"100%"}}
              onBlur={(e) => { onChange(e.target.value); setEditing(false); }}
              onKeyDown={(e) => { if(e.key==="Enter"){onChange(e.target.value);setEditing(false);} }} />
          </div>
        );
      }
      return (
        <div className="cell-editable" style={{padding:"0 10px",borderRight:"1px solid rgba(0,0,0,0.06)",fontSize:13,color:"#323338"}} onClick={(e) => { e.stopPropagation(); setEditing(true); }}>
          {fmtDate(value) || "-"}
        </div>
      );
    }

    // ===================== TEXT CELL (for title inline edit) =====================
    function TitleCell({ value, onChange, onClick }) {
      const [editing, setEditing] = useState(false);
      const [text, setText] = useState(value);
      const ref = useRef(null);

      useEffect(() => setText(value), [value]);

      if (editing) {
        return (
          <div style={{padding:"0 10px",minHeight:38,display:"flex",alignItems:"center",flex:1}} onClick={e => e.stopPropagation()}>
            <input ref={ref} type="text" value={text} autoFocus
              style={{border:"1px solid #0073ea",borderRadius:4,padding:"4px 8px",fontSize:13,outline:"none",width:"100%",fontWeight:500}}
              onChange={(e) => setText(e.target.value)}
              onBlur={() => { if(text.trim() && text !== value) onChange(text); setEditing(false); }}
              onKeyDown={(e) => { if(e.key==="Enter"){ if(text.trim() && text !== value) onChange(text); setEditing(false); } if(e.key==="Escape") setEditing(false); }} />
          </div>
        );
      }
      return (
        <div style={{padding:"0 10px",minHeight:38,display:"flex",alignItems:"center",flex:1,borderRight:"1px solid rgba(0,0,0,0.06)",cursor:"pointer"}}
          onClick={onClick}
          onDoubleClick={(e) => { e.stopPropagation(); setEditing(true); }}>
          <span style={{fontSize:13,fontWeight:500,color:"#323338",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{value}</span>
        </div>
      );
    }

    // ===================== GROUP HEADER =====================
    function GroupHeader({ status, count, collapsed, onToggle, color }) {
      return (
        <div className="group-header" onClick={onToggle}
          style={{background:color,color:"#fff",padding:"8px 16px",display:"flex",alignItems:"center",gap:10,borderRadius:collapsed?"6px":"6px 6px 0 0",marginTop:16}}>
          <span style={{transform:collapsed?"rotate(-90deg)":"rotate(0deg)",transition:"transform 0.15s",display:"flex"}}>
            <IcoChevDown size={16} color="#fff" />
          </span>
          <span style={{fontWeight:600,fontSize:14}}>{STATUS_MAP[status]?.label || status}</span>
          <span style={{background:"rgba(255,255,255,0.25)",padding:"1px 8px",borderRadius:10,fontSize:12,fontWeight:500}}>{count}</span>
        </div>
      );
    }

    // ===================== TABLE VIEW =====================
    function TableView({ tasks, onUpdate, onDelete, onSelectTask, searchQuery, setSearchQuery, filters, setFilters, boardId }) {
      const [collapsedGroups, setCollapsedGroups] = useState({});

      const boardTasks = useMemo(() => {
        let t = boardId ? tasks.filter(tk => tk.boardId === boardId) : tasks;
        if (searchQuery) t = t.filter(tk => tk.title.toLowerCase().includes(searchQuery.toLowerCase()));
        if (filters.status) t = t.filter(tk => tk.status === filters.status);
        if (filters.priority) t = t.filter(tk => tk.priority === filters.priority);
        if (filters.owner) t = t.filter(tk => tk.owner === filters.owner);
        return t;
      }, [tasks, boardId, searchQuery, filters]);

      const grouped = useMemo(() => {
        const groups = {};
        STATUS_ORDER.forEach(s => { groups[s] = []; });
        boardTasks.forEach(t => {
          if (!groups[t.status]) groups[t.status] = [];
          groups[t.status].push(t);
        });
        return groups;
      }, [boardTasks]);

      const toggleGroup = (s) => setCollapsedGroups(prev => ({...prev, [s]: !prev[s]}));

      return (
        <div>
          {/* Filter bar */}
          <div style={{display:"flex",gap:8,alignItems:"center",marginBottom:16,flexWrap:"wrap"}}>
            <div style={{position:"relative",flex:"1 1 300px",maxWidth:400}}>
              <IcoSearch size={16} color="#676879" className="" />
              <input type="text" placeholder="Search tasks..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}
                style={{width:"100%",padding:"7px 12px 7px 32px",border:"1px solid #c3c6d4",borderRadius:4,fontSize:13,outline:"none",fontFamily:"inherit",position:"relative"}} />
              <div style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",pointerEvents:"none"}}>
              </div>
            </div>
            <select value={filters.status||""} onChange={e => setFilters({...filters, status:e.target.value||null})}
              style={{padding:"7px 10px",border:"1px solid #c3c6d4",borderRadius:4,fontSize:13,fontFamily:"inherit",background:"#fff",cursor:"pointer"}}>
              <option value="">All Statuses</option>
              {STATUS_ORDER.map(s => <option key={s} value={s}>{STATUS_MAP[s].label}</option>)}
            </select>
            <select value={filters.priority||""} onChange={e => setFilters({...filters, priority:e.target.value||null})}
              style={{padding:"7px 10px",border:"1px solid #c3c6d4",borderRadius:4,fontSize:13,fontFamily:"inherit",background:"#fff",cursor:"pointer"}}>
              <option value="">All Priorities</option>
              {["critical","high","medium","low"].map(p => <option key={p} value={p}>{PRIORITY_MAP[p].label}</option>)}
            </select>
            <select value={filters.owner||""} onChange={e => setFilters({...filters, owner:e.target.value||null})}
              style={{padding:"7px 10px",border:"1px solid #c3c6d4",borderRadius:4,fontSize:13,fontFamily:"inherit",background:"#fff",cursor:"pointer"}}>
              <option value="">All Owners</option>
              {OWNERS.map(o => <option key={o} value={o}>{o}</option>)}
            </select>
            <span style={{fontSize:13,color:"#676879"}}>{boardTasks.length} tasks</span>
          </div>

          {/* Grouped table */}
          {STATUS_ORDER.map(status => {
            const groupTasks = grouped[status] || [];
            if (groupTasks.length === 0) return null;
            const isCollapsed = collapsedGroups[status];
            const groupColor = STATUS_MAP[status].color;
            return (
              <div key={status} style={{marginBottom:8}}>
                <GroupHeader status={status} count={groupTasks.length} collapsed={isCollapsed} onToggle={() => toggleGroup(status)} color={groupColor} />
                {!isCollapsed && (
                  <div style={{border:"1px solid #e6e9ef",borderTop:"none",borderRadius:"0 0 6px 6px",overflow:"hidden",background:"#fff"}}>
                    {/* Column headers */}
                    <div style={{display:"flex",borderBottom:"1px solid #e6e9ef",background:"#f6f7fb"}}>
                      <div style={{width:40,minHeight:32,display:"flex",alignItems:"center",justifyContent:"center",borderRight:"1px solid rgba(0,0,0,0.06)"}}>
                        <input type="checkbox" disabled style={{opacity:0.3}} />
                      </div>
                      <div style={{flex:"1 1 300px",padding:"0 10px",minHeight:32,display:"flex",alignItems:"center",borderRight:"1px solid rgba(0,0,0,0.06)",fontSize:12,fontWeight:600,color:"#676879",textTransform:"uppercase",letterSpacing:"0.5px"}}>Task</div>
                      <div style={{width:140,padding:"0 10px",minHeight:32,display:"flex",alignItems:"center",borderRight:"1px solid rgba(0,0,0,0.06)",fontSize:12,fontWeight:600,color:"#676879",textTransform:"uppercase",letterSpacing:"0.5px"}}>Owner</div>
                      <div style={{width:120,minHeight:32,display:"flex",alignItems:"center",justifyContent:"center",borderRight:"1px solid rgba(0,0,0,0.06)",fontSize:12,fontWeight:600,color:"#676879",textTransform:"uppercase",letterSpacing:"0.5px"}}>Status</div>
                      <div style={{width:100,minHeight:32,display:"flex",alignItems:"center",justifyContent:"center",borderRight:"1px solid rgba(0,0,0,0.06)",fontSize:12,fontWeight:600,color:"#676879",textTransform:"uppercase",letterSpacing:"0.5px"}}>Priority</div>
                      <div style={{width:110,padding:"0 10px",minHeight:32,display:"flex",alignItems:"center",borderRight:"1px solid rgba(0,0,0,0.06)",fontSize:12,fontWeight:600,color:"#676879",textTransform:"uppercase",letterSpacing:"0.5px"}}>Due Date</div>
                      {!boardId && <div style={{width:160,padding:"0 10px",minHeight:32,display:"flex",alignItems:"center",fontSize:12,fontWeight:600,color:"#676879",textTransform:"uppercase",letterSpacing:"0.5px"}}>Board</div>}
                    </div>
                    {/* Task rows */}
                    {groupTasks.map(task => (
                      <div key={task.id} className="task-row" style={{display:"flex",borderBottom:"1px solid #e6e9ef"}}>
                        <div style={{width:40,minHeight:38,display:"flex",alignItems:"center",justifyContent:"center",borderRight:"1px solid rgba(0,0,0,0.06)"}}>
                          <input type="checkbox" style={{cursor:"pointer"}} onClick={e => e.stopPropagation()} />
                        </div>
                        <TitleCell value={task.title} onChange={(v) => onUpdate(task.id, {title:v})} onClick={() => onSelectTask(task)} />
                        <div style={{width:140}}><OwnerCell value={task.owner} onChange={(v) => onUpdate(task.id, {owner:v})} /></div>
                        <div style={{width:120}}><StatusCell value={task.status} onChange={(v) => onUpdate(task.id, {status:v})} /></div>
                        <div style={{width:100}}><PriorityCell value={task.priority} onChange={(v) => onUpdate(task.id, {priority:v})} /></div>
                        <div style={{width:110}}><DateCell value={task.dueDate} onChange={(v) => onUpdate(task.id, {dueDate:v})} /></div>
                        {!boardId && <div style={{width:160,padding:"0 10px",minHeight:38,display:"flex",alignItems:"center",fontSize:12,color:"#676879",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{task.boardName}</div>}
                      </div>
                    ))}
                    {/* Group summary */}
                    <div style={{display:"flex",borderTop:"2px solid "+groupColor,background:"#f6f7fb",minHeight:32}}>
                      <div style={{flex:1,padding:"4px 16px",fontSize:12,color:"#676879",display:"flex",alignItems:"center"}}>
                        {groupTasks.length} {groupTasks.length === 1 ? "task" : "tasks"}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            );
          })}

          {boardTasks.length === 0 && (
            <div style={{textAlign:"center",padding:60,color:"#676879"}}>
              <p style={{fontSize:16,fontWeight:500}}>No tasks found</p>
              <p style={{fontSize:13,marginTop:8}}>Try adjusting your filters or search query</p>
            </div>
          )}
        </div>
      );
    }

    // ===================== KANBAN VIEW =====================
    function KanbanView({ tasks, onUpdate, onSelectTask, boardId }) {
      const boardTasks = boardId ? tasks.filter(t => t.boardId === boardId) : tasks;
      return (
        <div style={{display:"flex",gap:16,overflowX:"auto",padding:"4px 0",minHeight:"calc(100vh - 200px)"}}>
          {STATUS_ORDER.map(status => {
            const col = boardTasks.filter(t => t.status === status);
            const meta = STATUS_MAP[status];
            return (
              <div key={status} style={{minWidth:260,maxWidth:300,flex:"1 1 260px"}}>
                <div style={{display:"flex",alignItems:"center",gap:8,padding:"8px 4px",marginBottom:8}}>
                  <span style={{width:10,height:10,borderRadius:3,background:meta.color}}></span>
                  <span style={{fontSize:14,fontWeight:600,color:"#323338"}}>{meta.label}</span>
                  <span style={{fontSize:12,color:"#676879",background:"#e6e9ef",padding:"0 8px",borderRadius:10}}>{col.length}</span>
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:8}}>
                  {col.map(task => {
                    const pMeta = PRIORITY_MAP[task.priority];
                    return (
                      <div key={task.id} className="kanban-card" onClick={() => onSelectTask(task)}
                        style={{borderLeft:`3px solid ${meta.color}`}}>
                        <div style={{fontSize:13,fontWeight:500,color:"#323338",marginBottom:8,lineHeight:1.4}}>{task.title}</div>
                        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                          <div style={{display:"flex",alignItems:"center",gap:6}}>
                            <span className="owner-avatar" style={{background:ownerColor(task.owner),width:22,height:22,fontSize:9}}>{getInitials(task.owner)}</span>
                            <span style={{fontSize:11,color:"#676879"}}>{task.owner}</span>
                          </div>
                          <div style={{display:"flex",alignItems:"center",gap:6}}>
                            <span style={{fontSize:11,color:"#676879"}}>{fmtDate(task.dueDate)}</span>
                            <span style={{width:8,height:8,borderRadius:2,background:pMeta.color}} title={pMeta.label}></span>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    // ===================== CALENDAR VIEW =====================
    function CalendarView({ tasks, boardId }) {
      const boardTasks = boardId ? tasks.filter(t => t.boardId === boardId) : tasks;
      return (
        <div style={{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:16}}>
          {MONTHS.map((month, idx) => {
            const mTasks = boardTasks.filter(t => t.month === idx + 1);
            const done = mTasks.filter(t => t.status === "complete").length;
            const pct = mTasks.length > 0 ? Math.round((done / mTasks.length) * 100) : 0;
            const now = new Date();
            const isCurrent = now.getMonth() === idx;
            return (
              <div key={month} style={{background:"#fff",borderRadius:8,padding:20,border:isCurrent?"2px solid #0073ea":"1px solid #e6e9ef",boxShadow:"0 1px 4px rgba(0,0,0,0.04)"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
                  <span style={{fontSize:15,fontWeight:600,color:"#323338"}}>{month}</span>
                  {isCurrent && <span style={{fontSize:10,fontWeight:600,color:"#0073ea",background:"#cce5ff",padding:"2px 8px",borderRadius:10}}>CURRENT</span>}
                </div>
                <div style={{fontSize:28,fontWeight:700,color:"#323338"}}>{mTasks.length}</div>
                <div style={{fontSize:12,color:"#676879",marginTop:4}}>{done} completed</div>
                <div style={{marginTop:10,height:4,background:"#e6e9ef",borderRadius:2,overflow:"hidden"}}>
                  <div style={{height:"100%",background:"#00c875",width:`${pct}%`,borderRadius:2,transition:"width 0.3s"}}></div>
                </div>
                <div style={{fontSize:11,color:"#676879",marginTop:4,textAlign:"right"}}>{pct}%</div>
              </div>
            );
          })}
        </div>
      );
    }

    // ===================== DASHBOARD VIEW =====================
    function DashboardView({ tasks }) {
      const now = new Date();
      const total = tasks.length;
      const inProg = tasks.filter(t => t.status === "in_progress").length;
      const done = tasks.filter(t => t.status === "complete").length;
      const overdue = tasks.filter(t => new Date(t.dueDate) < now && t.status !== "complete").length;

      const domainProg = useMemo(() => {
        return Object.entries(DOMAIN_META).map(([id, meta]) => {
          const dt = tasks.filter(t => t.domainId === id);
          const dc = dt.filter(t => t.status === "complete").length;
          return { id, name: meta.name, color: meta.color, total: dt.length, done: dc, pct: dt.length ? Math.round((dc/dt.length)*100) : 0 };
        });
      }, [tasks]);

      const monthlyData = useMemo(() => MONTHS.map((m, i) => ({ name: m, tasks: tasks.filter(t => t.month === i+1).length })), [tasks]);

      const upcoming = useMemo(() => tasks.filter(t => t.status !== "complete" && new Date(t.dueDate) >= now).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).slice(0,6), [tasks]);

      const statusData = useMemo(() => STATUS_ORDER.map(s => ({
        name: STATUS_MAP[s].label, value: tasks.filter(t => t.status === s).length, color: STATUS_MAP[s].color
      })), [tasks]);

      return (
        <div>
          {/* Metric cards */}
          <div style={{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:16,marginBottom:24}}>
            {[
              { label: "Total Tasks", value: total, color: "#0073ea", icon: IcoTable },
              { label: "In Progress", value: inProg, color: "#fdab3d", icon: IcoClock },
              { label: "Overdue", value: overdue, color: "#e2445c", icon: IcoAlert },
              { label: "Completed", value: done, color: "#00c875", icon: IcoCheck },
            ].map((m, i) => (
              <div key={i} className="metric-card">
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                  <div>
                    <div style={{fontSize:13,color:"#676879",marginBottom:8}}>{m.label}</div>
                    <div style={{fontSize:32,fontWeight:700,color:"#323338"}}>{m.value}</div>
                  </div>
                  <div style={{width:40,height:40,borderRadius:8,background:m.color+"15",display:"flex",alignItems:"center",justifyContent:"center"}}>
                    <m.icon size={20} color={m.color} />
                  </div>
                </div>
              </div>
            ))}
          </div>

          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16,marginBottom:24}}>
            {/* Domain Progress */}
            <div className="metric-card">
              <h3 style={{fontSize:15,fontWeight:600,color:"#323338",marginBottom:16}}>Domain Progress</h3>
              <div style={{display:"flex",flexDirection:"column",gap:12}}>
                {domainProg.map(d => (
                  <div key={d.id}>
                    <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
                      <span style={{fontSize:13,fontWeight:500,color:"#323338"}}>{d.name}</span>
                      <span style={{fontSize:12,color:"#676879"}}>{d.done}/{d.total}</span>
                    </div>
                    <div style={{height:6,background:"#e6e9ef",borderRadius:3,overflow:"hidden"}}>
                      <div style={{height:"100%",background:d.color,width:`${d.pct}%`,borderRadius:3,transition:"width 0.3s"}}></div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Monthly Volume Chart */}
            <div className="metric-card">
              <h3 style={{fontSize:15,fontWeight:600,color:"#323338",marginBottom:16}}>Monthly Task Volume</h3>
              <ResponsiveContainer width="100%" height={220}>
                <BarChart data={monthlyData}>
                  <XAxis dataKey="name" tick={{fontSize:12}} />
                  <YAxis tick={{fontSize:12}} />
                  <Tooltip />
                  <Bar dataKey="tasks" fill="#0073ea" radius={[3,3,0,0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}>
            {/* Status Distribution */}
            <div className="metric-card">
              <h3 style={{fontSize:15,fontWeight:600,color:"#323338",marginBottom:16}}>Status Distribution</h3>
              <ResponsiveContainer width="100%" height={220}>
                <PieChart>
                  <Pie data={statusData} dataKey="value" nameKey="name" cx="50%" cy="50%" innerRadius={50} outerRadius={80} paddingAngle={2}>
                    {statusData.map((e,i) => <Cell key={i} fill={e.color} />)}
                  </Pie>
                  <Tooltip />
                  <Legend iconType="circle" wrapperStyle={{fontSize:12}} />
                </PieChart>
              </ResponsiveContainer>
            </div>

            {/* Upcoming Deadlines */}
            <div className="metric-card">
              <h3 style={{fontSize:15,fontWeight:600,color:"#323338",marginBottom:16}}>Upcoming Deadlines</h3>
              <div style={{display:"flex",flexDirection:"column",gap:8}}>
                {upcoming.map(t => (
                  <div key={t.id} style={{display:"flex",alignItems:"center",gap:10,padding:"8px 10px",background:"#f6f7fb",borderRadius:6}}>
                    <span className="owner-avatar" style={{background:ownerColor(t.owner),width:24,height:24,fontSize:9}}>{getInitials(t.owner)}</span>
                    <div style={{flex:1,overflow:"hidden"}}>
                      <div style={{fontSize:13,fontWeight:500,color:"#323338",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{t.title}</div>
                      <div style={{fontSize:11,color:"#676879"}}>{t.boardName}</div>
                    </div>
                    <span style={{fontSize:12,color:"#676879",whiteSpace:"nowrap"}}>{fmtDate(t.dueDate)}</span>
                  </div>
                ))}
                {upcoming.length === 0 && <div style={{fontSize:13,color:"#676879",textAlign:"center",padding:20}}>No upcoming deadlines</div>}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ===================== ITEM DETAIL PANEL =====================
    function ItemDetailPanel({ task, onClose, onUpdate, onDelete, tasks }) {
      const [activeTab, setActiveTab] = useState("updates");
      const [commentText, setCommentText] = useState("");
      const [activity, setActivity] = useState([]);
      const [loadingActivity, setLoadingActivity] = useState(false);

      const fetchActivity = useCallback(async () => {
        if (!task) return;
        setLoadingActivity(true);
        try {
          const res = await fetch(`${API}/tasks/${task.id}/activity`);
          if (res.ok) setActivity(await res.json());
        } catch(e) { console.error(e); }
        setLoadingActivity(false);
      }, [task]);

      useEffect(() => { fetchActivity(); }, [fetchActivity]);

      const submitComment = async () => {
        if (!commentText.trim()) return;
        try {
          await fetch(`${API}/tasks/${task.id}/comments`, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ text: commentText, author: "User" }),
          });
          setCommentText("");
          fetchActivity();
        } catch(e) { console.error(e); }
      };

      if (!task) return null;
      const sMeta = STATUS_MAP[task.status] || STATUS_MAP.not_started;
      const pMeta = PRIORITY_MAP[task.priority] || PRIORITY_MAP.medium;
      const comments = activity.filter(a => a.type === "comment");
      const changes = activity.filter(a => a.type === "field_change");

      return (
        <React.Fragment>
          {/* Overlay */}
          <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.3)",zIndex:90}} onClick={onClose} className="fade-enter" />
          {/* Panel */}
          <div className="detail-panel">
            {/* Header */}
            <div style={{padding:"16px 20px",borderBottom:"1px solid #e6e9ef",display:"flex",justifyContent:"space-between",alignItems:"center",flexShrink:0}}>
              <div style={{fontSize:12,color:"#676879"}}>{task.boardName}</div>
              <div style={{display:"flex",gap:8}}>
                <button onClick={() => onDelete(task.id)} style={{background:"none",border:"none",cursor:"pointer",padding:4,borderRadius:4,color:"#676879"}} title="Delete">
                  <IcoTrash size={16} />
                </button>
                <button onClick={onClose} style={{background:"none",border:"none",cursor:"pointer",padding:4,borderRadius:4,color:"#676879"}}>
                  <IcoX size={18} />
                </button>
              </div>
            </div>

            {/* Title */}
            <div style={{padding:"16px 20px 0 20px",flexShrink:0}}>
              <h2 style={{fontSize:20,fontWeight:600,color:"#323338",margin:0,lineHeight:1.4}}>{task.title}</h2>
            </div>

            {/* Properties grid */}
            <div style={{padding:"16px 20px",display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,flexShrink:0}}>
              <div>
                <label style={{fontSize:11,fontWeight:600,color:"#676879",textTransform:"uppercase",letterSpacing:"0.5px",display:"block",marginBottom:4}}>Status</label>
                <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
                  {STATUS_ORDER.map(s => (
                    <button key={s} onClick={() => onUpdate(task.id, {status:s})}
                      style={{padding:"4px 10px",borderRadius:4,fontSize:12,fontWeight:500,border:"none",cursor:"pointer",
                        background: task.status === s ? STATUS_MAP[s].color : "#e6e9ef",
                        color: task.status === s ? "#fff" : "#676879",
                      }}>
                      {STATUS_MAP[s].label}
                    </button>
                  ))}
                </div>
              </div>
              <div>
                <label style={{fontSize:11,fontWeight:600,color:"#676879",textTransform:"uppercase",letterSpacing:"0.5px",display:"block",marginBottom:4}}>Priority</label>
                <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
                  {["critical","high","medium","low"].map(p => (
                    <button key={p} onClick={() => onUpdate(task.id, {priority:p})}
                      style={{padding:"4px 10px",borderRadius:4,fontSize:12,fontWeight:500,border:"none",cursor:"pointer",
                        background: task.priority === p ? PRIORITY_MAP[p].color : "#e6e9ef",
                        color: task.priority === p ? "#fff" : "#676879",
                      }}>
                      {PRIORITY_MAP[p].label}
                    </button>
                  ))}
                </div>
              </div>
              <div>
                <label style={{fontSize:11,fontWeight:600,color:"#676879",textTransform:"uppercase",letterSpacing:"0.5px",display:"block",marginBottom:4}}>Owner</label>
                <select value={task.owner} onChange={e => onUpdate(task.id, {owner:e.target.value})}
                  style={{padding:"6px 8px",border:"1px solid #c3c6d4",borderRadius:4,fontSize:13,fontFamily:"inherit",width:"100%",background:"#fff",cursor:"pointer"}}>
                  {OWNERS.map(o => <option key={o} value={o}>{o}</option>)}
                </select>
              </div>
              <div>
                <label style={{fontSize:11,fontWeight:600,color:"#676879",textTransform:"uppercase",letterSpacing:"0.5px",display:"block",marginBottom:4}}>Due Date</label>
                <input type="date" value={task.dueDate?.split("T")[0] || ""} onChange={e => onUpdate(task.id, {dueDate:e.target.value})}
                  style={{padding:"6px 8px",border:"1px solid #c3c6d4",borderRadius:4,fontSize:13,fontFamily:"inherit",width:"100%"}} />
              </div>
            </div>

            {/* Tabs */}
            <div style={{display:"flex",gap:0,borderBottom:"1px solid #e6e9ef",padding:"0 20px",flexShrink:0}}>
              {[
                { id: "updates", label: "Updates", icon: IcoMsg },
                { id: "activity", label: "Activity Log", icon: IcoActivity },
              ].map(tab => (
                <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                  style={{padding:"10px 16px",fontSize:13,fontWeight:500,cursor:"pointer",border:"none",background:"none",
                    borderBottom: activeTab === tab.id ? "2px solid #0073ea" : "2px solid transparent",
                    color: activeTab === tab.id ? "#0073ea" : "#676879",
                    display:"flex",alignItems:"center",gap:6,
                  }}>
                  <tab.icon size={14} /> {tab.label}
                </button>
              ))}
            </div>

            {/* Tab content */}
            <div style={{flex:1,overflow:"auto",padding:20}}>
              {activeTab === "updates" && (
                <div>
                  {/* Comment input */}
                  <div style={{marginBottom:16}}>
                    <div style={{border:"1px solid #c3c6d4",borderRadius:8,overflow:"hidden"}}>
                      <textarea value={commentText} onChange={e => setCommentText(e.target.value)}
                        placeholder="Write an update..."
                        style={{width:"100%",padding:"10px 12px",border:"none",outline:"none",resize:"none",fontSize:13,fontFamily:"inherit",minHeight:60}} />
                      <div style={{display:"flex",justifyContent:"flex-end",padding:"6px 8px",borderTop:"1px solid #e6e9ef",background:"#f6f7fb"}}>
                        <button onClick={submitComment} disabled={!commentText.trim()}
                          style={{padding:"5px 14px",background:commentText.trim()?"#0073ea":"#c3c6d4",color:"#fff",border:"none",borderRadius:4,fontSize:12,fontWeight:500,cursor:commentText.trim()?"pointer":"default",display:"flex",alignItems:"center",gap:4}}>
                          <IcoSend size={12} /> Update
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* Comments list */}
                  {comments.length === 0 && <div style={{textAlign:"center",padding:20,color:"#676879",fontSize:13}}>No updates yet. Be the first to post!</div>}
                  {comments.map((c, i) => (
                    <div key={i} style={{marginBottom:12,padding:12,background:"#f6f7fb",borderRadius:8}}>
                      <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:6}}>
                        <span className="owner-avatar" style={{background:"#0073ea",width:28,height:28,fontSize:11}}>{getInitials(c.author || "User")}</span>
                        <div>
                          <span style={{fontSize:13,fontWeight:600,color:"#323338"}}>{c.author || "User"}</span>
                          <span style={{fontSize:11,color:"#676879",marginLeft:8}}>{fmtDateFull(c.timestamp)} {fmtTime(c.timestamp)}</span>
                        </div>
                      </div>
                      <div style={{fontSize:13,color:"#323338",lineHeight:1.5,paddingLeft:36}}>{c.text}</div>
                    </div>
                  ))}
                </div>
              )}

              {activeTab === "activity" && (
                <div>
                  {changes.length === 0 && <div style={{textAlign:"center",padding:20,color:"#676879",fontSize:13}}>No activity logged yet</div>}
                  {changes.map((a, i) => {
                    const fieldLabel = { status: "Status", owner: "Owner", priority: "Priority", dueDate: "Due Date", title: "Title" }[a.field] || a.field;
                    const oldDisplay = a.field === "status" ? (STATUS_MAP[a.oldValue]?.label || a.oldValue) :
                                       a.field === "priority" ? (PRIORITY_MAP[a.oldValue]?.label || a.oldValue) : (a.oldValue || "(empty)");
                    const newDisplay = a.field === "status" ? (STATUS_MAP[a.newValue]?.label || a.newValue) :
                                       a.field === "priority" ? (PRIORITY_MAP[a.newValue]?.label || a.newValue) : a.newValue;
                    return (
                      <div key={i} style={{display:"flex",gap:12,padding:"10px 0",borderBottom:"1px solid #e6e9ef"}}>
                        <div style={{width:6,borderRadius:3,background:"#c3c6d4",flexShrink:0}}></div>
                        <div>
                          <div style={{fontSize:13,color:"#323338"}}>
                            <strong>{fieldLabel}</strong> changed from <span style={{textDecoration:"line-through",color:"#676879"}}>{oldDisplay}</span> to <strong>{newDisplay}</strong>
                          </div>
                          <div style={{fontSize:11,color:"#676879",marginTop:2}}>{fmtDateFull(a.timestamp)} {fmtTime(a.timestamp)}</div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        </React.Fragment>
      );
    }

    // ===================== ADD TASK MODAL =====================
    function AddTaskModal({ boardId, boardName, domainId, domainName, onClose, onCreate }) {
      const [title, setTitle] = useState("");
      const [owner, setOwner] = useState("Analyst");
      const [priority, setPriority] = useState("medium");
      const [dueDate, setDueDate] = useState(new Date().toISOString().split("T")[0]);
      const [month, setMonth] = useState(String(new Date().getMonth() + 1));

      const handleCreate = () => {
        if (!title.trim()) return;
        onCreate({ title, owner, priority, dueDate, month: parseInt(month), status: "not_started", boardId, boardName, domainId, domainName, notes: "" });
      };

      return (
        <React.Fragment>
          <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.35)",zIndex:100}} onClick={onClose} className="fade-enter" />
          <div style={{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%,-50%)",background:"#fff",borderRadius:12,padding:24,width:440,zIndex:110,boxShadow:"0 12px 40px rgba(0,0,0,0.2)"}} className="fade-enter" onClick={e => e.stopPropagation()}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
              <h3 style={{fontSize:18,fontWeight:600,color:"#323338",margin:0}}>New Task</h3>
              <button onClick={onClose} style={{background:"none",border:"none",cursor:"pointer",padding:4}}><IcoX size={18} color="#676879" /></button>
            </div>
            <div style={{display:"flex",flexDirection:"column",gap:14}}>
              <div>
                <label style={{fontSize:12,fontWeight:600,color:"#676879",display:"block",marginBottom:4}}>Task Title *</label>
                <input type="text" value={title} onChange={e => setTitle(e.target.value)} placeholder="What needs to be done?"
                  autoFocus style={{width:"100%",padding:"8px 12px",border:"1px solid #c3c6d4",borderRadius:6,fontSize:14,fontFamily:"inherit",outline:"none"}} />
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
                <div>
                  <label style={{fontSize:12,fontWeight:600,color:"#676879",display:"block",marginBottom:4}}>Owner</label>
                  <select value={owner} onChange={e => setOwner(e.target.value)} style={{width:"100%",padding:"8px",border:"1px solid #c3c6d4",borderRadius:6,fontSize:13,fontFamily:"inherit"}}>
                    {OWNERS.map(o => <option key={o} value={o}>{o}</option>)}
                  </select>
                </div>
                <div>
                  <label style={{fontSize:12,fontWeight:600,color:"#676879",display:"block",marginBottom:4}}>Priority</label>
                  <select value={priority} onChange={e => setPriority(e.target.value)} style={{width:"100%",padding:"8px",border:"1px solid #c3c6d4",borderRadius:6,fontSize:13,fontFamily:"inherit"}}>
                    {["critical","high","medium","low"].map(p => <option key={p} value={p}>{PRIORITY_MAP[p].label}</option>)}
                  </select>
                </div>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
                <div>
                  <label style={{fontSize:12,fontWeight:600,color:"#676879",display:"block",marginBottom:4}}>Due Date</label>
                  <input type="date" value={dueDate} onChange={e => setDueDate(e.target.value)} style={{width:"100%",padding:"8px",border:"1px solid #c3c6d4",borderRadius:6,fontSize:13,fontFamily:"inherit"}} />
                </div>
                <div>
                  <label style={{fontSize:12,fontWeight:600,color:"#676879",display:"block",marginBottom:4}}>Month</label>
                  <select value={month} onChange={e => setMonth(e.target.value)} style={{width:"100%",padding:"8px",border:"1px solid #c3c6d4",borderRadius:6,fontSize:13,fontFamily:"inherit"}}>
                    {MONTHS.map((m,i) => <option key={i} value={i+1}>{m}</option>)}
                  </select>
                </div>
              </div>
              <div style={{display:"flex",gap:10,marginTop:6}}>
                <button onClick={handleCreate}
                  style={{flex:1,padding:"10px",background:"#0073ea",color:"#fff",border:"none",borderRadius:6,fontSize:14,fontWeight:600,cursor:"pointer"}}>
                  Add Task
                </button>
                <button onClick={onClose}
                  style={{flex:1,padding:"10px",background:"#e6e9ef",color:"#323338",border:"none",borderRadius:6,fontSize:14,fontWeight:500,cursor:"pointer"}}>
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </React.Fragment>
      );
    }

    // ===================== MAIN APP =====================
    function App() {
      // State
      const [tasks, setTasks] = useState([]);
      const [loading, setLoading] = useState(true);
      const [currentBoard, setCurrentBoard] = useState(null); // null = "All Tasks" / Dashboard
      const [currentView, setCurrentView] = useState("table"); // table | kanban | calendar | dashboard
      const [selectedTask, setSelectedTask] = useState(null);
      const [addTaskModal, setAddTaskModal] = useState(null); // { boardId, boardName, domainId, domainName }
      const [toast, setToast] = useState(null);
      const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
      const [expandedDomains, setExpandedDomains] = useState({"base-pay": true, "variable-pay": true, "exec-comp": true});
      const [searchQuery, setSearchQuery] = useState("");
      const [filters, setFilters] = useState({ status: null, priority: null, owner: null });
      const [sidebarSearch, setSidebarSearch] = useState("");

      // Fetch
      const fetchTasks = useCallback(async () => {
        try {
          const res = await fetch(`${API}/tasks`);
          if (!res.ok) throw new Error();
          setTasks(await res.json());
        } catch(e) { setToast({ message: "Failed to load tasks", type: "error" }); }
        finally { setLoading(false); }
      }, []);

      useEffect(() => { fetchTasks(); const iv = setInterval(fetchTasks, 5000); return () => clearInterval(iv); }, [fetchTasks]);

      // Mutations
      const updateTask = useCallback(async (id, updates) => {
        // Optimistic update
        setTasks(prev => prev.map(t => t.id === id ? {...t, ...updates, updatedAt: new Date().toISOString()} : t));
        if (selectedTask && selectedTask.id === id) {
          setSelectedTask(prev => prev ? {...prev, ...updates} : prev);
        }
        try {
          const res = await fetch(`${API}/tasks/${id}`, { method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify(updates) });
          if (!res.ok) throw new Error();
        } catch(e) { setToast({ message: "Failed to update", type: "error" }); fetchTasks(); }
      }, [fetchTasks, selectedTask]);

      const deleteTask = useCallback(async (id) => {
        if (!window.confirm("Delete this task?")) return;
        try {
          const res = await fetch(`${API}/tasks/${id}`, { method:"DELETE" });
          if (!res.ok) throw new Error();
          setSelectedTask(null);
          fetchTasks();
          setToast({ message: "Task deleted", type: "success" });
        } catch(e) { setToast({ message: "Failed to delete", type: "error" }); }
      }, [fetchTasks]);

      const createTask = useCallback(async (t) => {
        try {
          const res = await fetch(`${API}/tasks`, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(t) });
          if (!res.ok) throw new Error();
          setAddTaskModal(null);
          fetchTasks();
          setToast({ message: "Task created", type: "success" });
        } catch(e) { setToast({ message: "Failed to create", type: "error" }); }
      }, [fetchTasks]);

      const resetAll = useCallback(async () => {
        if (!window.confirm("Reset all tasks to defaults? This removes all custom changes.")) return;
        try {
          await fetch(`${API}/seed`, { method:"POST" });
          fetchTasks();
          setToast({ message: "Reset complete", type: "success" });
        } catch(e) { setToast({ message: "Reset failed", type: "error" }); }
      }, [fetchTasks]);

      // Board helpers
      const boardMeta = currentBoard ? BOARDS.find(b => b.id === currentBoard) : null;
      const domainMeta = boardMeta ? DOMAIN_META[boardMeta.domain] : null;

      const boardTaskCount = (boardId) => tasks.filter(t => t.boardId === boardId).length;
      const boardDoneCount = (boardId) => tasks.filter(t => t.boardId === boardId && t.status === "complete").length;

      // Filtered boards for sidebar search
      const filteredBoards = useMemo(() => {
        if (!sidebarSearch) return BOARDS;
        return BOARDS.filter(b => b.name.toLowerCase().includes(sidebarSearch.toLowerCase()));
      }, [sidebarSearch]);

      const handleSelectTask = (task) => {
        setSelectedTask({...task});
      };

      const handleAddTask = () => {
        if (boardMeta) {
          setAddTaskModal({ boardId: boardMeta.id, boardName: boardMeta.name, domainId: boardMeta.domain, domainName: DOMAIN_META[boardMeta.domain].name });
        } else {
          // Default to first board
          const b = BOARDS[0];
          setAddTaskModal({ boardId: b.id, boardName: b.name, domainId: b.domain, domainName: DOMAIN_META[b.domain].name });
        }
      };

      if (loading) {
        return (
          <div style={{display:"flex",alignItems:"center",justifyContent:"center",height:"100vh",background:"#f6f7fb"}}>
            <div style={{textAlign:"center"}}>
              <div style={{width:40,height:40,border:"3px solid #e6e9ef",borderTopColor:"#0073ea",borderRadius:"50%",animation:"spin 0.8s linear infinite",margin:"0 auto 16px"}}></div>
              <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
              <p style={{color:"#676879",fontSize:14}}>Loading CompHub...</p>
            </div>
          </div>
        );
      }

      return (
        <div style={{display:"flex",height:"100vh",overflow:"hidden"}}>
          {/* ===== SIDEBAR ===== */}
          <div style={{width: sidebarCollapsed ? 48 : 260, background:"#292f4c", color:"#fff", display:"flex", flexDirection:"column", transition:"width 0.2s", flexShrink:0, overflow:"hidden"}}>
            {/* Logo */}
            <div style={{padding: sidebarCollapsed ? "16px 8px" : "16px 16px", borderBottom:"1px solid rgba(255,255,255,0.08)", display:"flex", alignItems:"center", gap:10, minHeight:56}}>
              {!sidebarCollapsed && (
                <React.Fragment>
                  <div style={{width:32,height:32,borderRadius:8,background:"#0073ea",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:700,fontSize:14}}>C</div>
                  <div>
                    <div style={{fontSize:15,fontWeight:700}}>CompHub</div>
                    <div style={{fontSize:10,color:"#9699a8"}}>Comp Ops Center</div>
                  </div>
                </React.Fragment>
              )}
              <button onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
                style={{marginLeft:"auto",background:"none",border:"none",cursor:"pointer",padding:4,borderRadius:4,color:"#9699a8",display:"flex"}}>
                <IcoMenu size={16} />
              </button>
            </div>

            {!sidebarCollapsed && (
              <React.Fragment>
                {/* Sidebar search */}
                <div style={{padding:"12px 12px 8px 12px"}}>
                  <div style={{position:"relative"}}>
                    <input type="text" placeholder="Search boards..." value={sidebarSearch} onChange={e => setSidebarSearch(e.target.value)}
                      style={{width:"100%",padding:"6px 10px 6px 30px",background:"rgba(255,255,255,0.08)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:4,fontSize:12,color:"#fff",outline:"none",fontFamily:"inherit"}} />
                    <IcoSearch size={13} color="#9699a8" className="" />
                    <div style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",pointerEvents:"none"}}></div>
                  </div>
                </div>

                {/* Home / Dashboard */}
                <div style={{padding:"4px 12px"}}>
                  <div className={`sidebar-board-item ${!currentBoard && currentView === "dashboard" ? "active" : ""}`}
                    style={{paddingLeft:12}} onClick={() => { setCurrentBoard(null); setCurrentView("dashboard"); }}>
                    <IcoHome size={14} /> Dashboard
                  </div>
                  <div className={`sidebar-board-item ${!currentBoard && currentView === "table" ? "active" : ""}`}
                    style={{paddingLeft:12}} onClick={() => { setCurrentBoard(null); setCurrentView("table"); }}>
                    <IcoTable size={14} /> All Tasks
                  </div>
                </div>

                {/* Domain sections */}
                <div style={{flex:1,overflow:"auto",padding:"8px 12px"}}>
                  {Object.entries(DOMAIN_META).map(([domainId, meta]) => {
                    const domainBoards = filteredBoards.filter(b => b.domain === domainId);
                    if (sidebarSearch && domainBoards.length === 0) return null;
                    const expanded = expandedDomains[domainId];
                    return (
                      <div key={domainId} style={{marginBottom:4}}>
                        <div className="sidebar-domain-header" onClick={() => setExpandedDomains(prev => ({...prev, [domainId]: !prev[domainId]}))}>
                          <span style={{transform: expanded ? "rotate(0deg)" : "rotate(-90deg)", transition:"transform 0.15s", display:"flex"}}>
                            <IcoChevDown size={12} color="#9699a8" />
                          </span>
                          <span style={{width:8,height:8,borderRadius:2,background:meta.color,flexShrink:0}}></span>
                          <span style={{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{meta.name}</span>
                        </div>
                        {expanded && domainBoards.map(board => {
                          const count = boardTaskCount(board.id);
                          const doneC = boardDoneCount(board.id);
                          return (
                            <div key={board.id} className={`sidebar-board-item ${currentBoard === board.id ? "active" : ""}`}
                              onClick={() => { setCurrentBoard(board.id); if(currentView === "dashboard") setCurrentView("table"); }}>
                              <span style={{flex:1,overflow:"hidden",textOverflow:"ellipsis"}}>{board.name}</span>
                              <span style={{fontSize:10,color:"#9699a8",flexShrink:0}}>{doneC}/{count}</span>
                            </div>
                          );
                        })}
                      </div>
                    );
                  })}
                </div>

                {/* Bottom actions */}
                <div style={{padding:12,borderTop:"1px solid rgba(255,255,255,0.08)"}}>
                  <button onClick={resetAll}
                    style={{width:"100%",padding:"8px",background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:4,color:"#9699a8",fontSize:12,cursor:"pointer",fontFamily:"inherit",display:"flex",alignItems:"center",justifyContent:"center",gap:6}}>
                    <IcoRefresh size={13} /> Reset to Defaults
                  </button>
                </div>
              </React.Fragment>
            )}
          </div>

          {/* ===== MAIN AREA ===== */}
          <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
            {/* Top bar */}
            <div style={{background:"#fff",borderBottom:"1px solid #e6e9ef",padding:"12px 24px",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}>
              <div style={{display:"flex",alignItems:"center",gap:12}}>
                {boardMeta && (
                  <span style={{width:10,height:10,borderRadius:3,background:domainMeta?.color || "#888"}}></span>
                )}
                <h1 style={{fontSize:20,fontWeight:700,color:"#323338",margin:0}}>
                  {boardMeta ? boardMeta.name : (currentView === "dashboard" ? "Dashboard" : "All Tasks")}
                </h1>
                {boardMeta && (
                  <span style={{fontSize:12,color:"#676879",background:"#e6e9ef",padding:"2px 8px",borderRadius:4}}>
                    {boardTaskCount(boardMeta.id)} tasks
                  </span>
                )}
              </div>
              <div style={{display:"flex",alignItems:"center",gap:8}}>
                {/* View tabs */}
                {["table","kanban","calendar","dashboard"].map(v => {
                  const icons = { table: IcoTable, kanban: IcoKanban, calendar: IcoCal, dashboard: IcoDash };
                  const labels = { table: "Table", kanban: "Kanban", calendar: "Calendar", dashboard: "Dashboard" };
                  const Ico = icons[v];
                  return (
                    <button key={v} className={`view-tab ${currentView === v ? "active" : ""}`} onClick={() => setCurrentView(v)}>
                      <span style={{display:"flex",alignItems:"center",gap:5}}><Ico size={14} /> {labels[v]}</span>
                    </button>
                  );
                })}
                <div style={{width:1,height:24,background:"#e6e9ef",margin:"0 4px"}}></div>
                <button onClick={handleAddTask}
                  style={{padding:"7px 16px",background:"#0073ea",color:"#fff",border:"none",borderRadius:4,fontSize:13,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:5,fontFamily:"inherit"}}>
                  <IcoPlus size={14} color="#fff" /> New Task
                </button>
              </div>
            </div>

            {/* Board progress bar (for specific boards) */}
            {boardMeta && (
              <div style={{padding:"0 24px",background:"#fff",paddingBottom:8}}>
                <div style={{display:"flex",alignItems:"center",gap:12}}>
                  <div style={{flex:1,height:4,background:"#e6e9ef",borderRadius:2,overflow:"hidden"}}>
                    <div style={{height:"100%",background:domainMeta?.color||"#0073ea",width:`${boardTaskCount(boardMeta.id) > 0 ? (boardDoneCount(boardMeta.id)/boardTaskCount(boardMeta.id))*100 : 0}%`,borderRadius:2,transition:"width 0.3s"}}></div>
                  </div>
                  <span style={{fontSize:12,color:"#676879",flexShrink:0}}>{boardDoneCount(boardMeta.id)}/{boardTaskCount(boardMeta.id)} done</span>
                </div>
              </div>
            )}

            {/* Content area */}
            <div style={{flex:1,overflow:"auto",padding:24}}>
              {currentView === "dashboard" && <DashboardView tasks={currentBoard ? tasks.filter(t => t.boardId === currentBoard) : tasks} />}
              {currentView === "table" && (
                <TableView tasks={tasks} onUpdate={updateTask} onDelete={deleteTask} onSelectTask={handleSelectTask}
                  searchQuery={searchQuery} setSearchQuery={setSearchQuery} filters={filters} setFilters={setFilters}
                  boardId={currentBoard} />
              )}
              {currentView === "kanban" && <KanbanView tasks={tasks} onUpdate={updateTask} onSelectTask={handleSelectTask} boardId={currentBoard} />}
              {currentView === "calendar" && <CalendarView tasks={tasks} boardId={currentBoard} />}
            </div>
          </div>

          {/* Detail Panel */}
          {selectedTask && (
            <ItemDetailPanel task={selectedTask} onClose={() => setSelectedTask(null)} onUpdate={updateTask} onDelete={deleteTask} tasks={tasks} />
          )}

          {/* Add Task Modal */}
          {addTaskModal && (
            <AddTaskModal {...addTaskModal} onClose={() => setAddTaskModal(null)} onCreate={createTask} />
          )}

          {/* Toast */}
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
        </div>
      );
    }

    // ===================== RENDER =====================
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
